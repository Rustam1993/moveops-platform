openapi: 3.0.3
info:
  title: MoveOps API
  version: 0.1.0
servers:
  - url: /api
paths:
  /health:
    get:
      operationId: GetHealth
      summary: Liveness probe
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: ok
  /auth/login:
    post:
      operationId: PostAuthLogin
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSessionResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /auth/logout:
    post:
      operationId: PostAuthLogout
      summary: Logout current session
      responses:
        '204':
          description: Logged out
        default:
          $ref: '#/components/responses/ErrorResponse'
  /auth/me:
    get:
      operationId: GetAuthMe
      summary: Get current user and tenant
      responses:
        '200':
          description: Current session principal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSessionResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /auth/csrf:
    get:
      operationId: GetAuthCsrf
      summary: Get csrf token for session
      responses:
        '200':
          description: CSRF token response
          content:
            application/json:
              schema:
                type: object
                required: [csrfToken]
                properties:
                  csrfToken:
                    type: string
        default:
          $ref: '#/components/responses/ErrorResponse'
  /customers:
    post:
      operationId: PostCustomers
      summary: Create customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomerRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /customers/{customerId}:
    get:
      operationId: GetCustomersCustomerId
      summary: Get customer by id
      parameters:
        - in: path
          name: customerId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Customer details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /estimates:
    post:
      operationId: PostEstimates
      summary: Create a draft estimate
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEstimateRequest'
      responses:
        '201':
          description: Draft estimate created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EstimateResponse'
        '200':
          description: Idempotent replay returned existing estimate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EstimateResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /estimates/{estimateId}:
    get:
      operationId: GetEstimatesEstimateId
      summary: Get estimate by id
      parameters:
        - in: path
          name: estimateId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Estimate details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EstimateResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
    patch:
      operationId: PatchEstimatesEstimateId
      summary: Update estimate fields
      parameters:
        - in: path
          name: estimateId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEstimateRequest'
      responses:
        '200':
          description: Estimate updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EstimateResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /estimates/{estimateId}/convert:
    post:
      operationId: PostEstimatesEstimateIdConvert
      summary: Convert estimate to job (idempotent)
      parameters:
        - in: path
          name: estimateId
          required: true
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '201':
          description: Job created from estimate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '200':
          description: Idempotent replay returned existing job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /calendar:
    get:
      operationId: GetCalendar
      summary: List scheduled jobs for a monthly calendar range
      description: >
        Returns jobs where `scheduledDate` is within `[from, to)` (inclusive `from`, exclusive `to`).
        `userId` and `departmentId` are accepted as filter placeholders but are currently ignored.
      parameters:
        - in: query
          name: from
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: to
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: phase
          required: false
          schema:
            type: string
            enum: [booked, scheduled, completed, cancelled]
        - in: query
          name: jobType
          required: false
          schema:
            type: string
            enum: [local, long_distance, other]
        - in: query
          name: userId
          required: false
          description: Placeholder filter; accepted but currently ignored.
          schema:
            type: string
            format: uuid
        - in: query
          name: departmentId
          required: false
          description: Placeholder filter; accepted but currently ignored.
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Calendar jobs in range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /jobs/{jobId}:
    get:
      operationId: GetJobsJobId
      summary: Get job by id
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
    patch:
      operationId: PatchJobsJobId
      summary: Update minimal job scheduling fields
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobRequest'
      responses:
        '200':
          description: Job updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /jobs/{jobId}/storage:
    post:
      operationId: PostJobsJobIdStorage
      summary: Create a storage record for a job
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStorageRecordRequest'
      responses:
        '201':
          description: Storage record created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageRecordResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /storage:
    get:
      operationId: GetStorage
      summary: List storage rows for a facility
      parameters:
        - in: query
          name: facility
          required: true
          schema:
            type: string
            minLength: 1
        - in: query
          name: q
          required: false
          schema:
            type: string
        - in: query
          name: status
          required: false
          schema:
            $ref: '#/components/schemas/StorageStatus'
        - in: query
          name: hasDateOut
          required: false
          schema:
            type: boolean
        - in: query
          name: balanceDue
          required: false
          schema:
            type: boolean
        - in: query
          name: pastDueDays
          required: false
          schema:
            type: integer
            minimum: 0
        - in: query
          name: hasContainers
          required: false
          schema:
            type: boolean
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
        - in: query
          name: cursor
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Storage rows
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageListResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
  /storage/{storageRecordId}:
    get:
      operationId: GetStorageStorageRecordId
      summary: Get storage record by id
      parameters:
        - in: path
          name: storageRecordId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Storage record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageRecordResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
    put:
      operationId: PutStorageStorageRecordId
      summary: Replace editable storage record fields
      parameters:
        - in: path
          name: storageRecordId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStorageRecordRequest'
      responses:
        '200':
          description: Storage record updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageRecordResponse'
        default:
          $ref: '#/components/responses/ErrorResponse'
components:
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string
        minLength: 1
        maxLength: 128
  responses:
    ErrorResponse:
      description: Standard API error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
  schemas:
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
    AuthSessionResponse:
      type: object
      required: [user, tenant]
      properties:
        user:
          $ref: '#/components/schemas/User'
        tenant:
          $ref: '#/components/schemas/Tenant'
    Tenant:
      type: object
      required: [id, slug, name]
      properties:
        id:
          type: string
          format: uuid
        slug:
          type: string
        name:
          type: string
    User:
      type: object
      required: [id, email, fullName]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        fullName:
          type: string
    CreateCustomerRequest:
      type: object
      required: [firstName, lastName]
      properties:
        firstName:
          type: string
          minLength: 1
        lastName:
          type: string
          minLength: 1
        email:
          type: string
          format: email
        phone:
          type: string
    Customer:
      type: object
      required: [id, tenantId, firstName, lastName, createdAt, updatedAt]
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    CreateEstimateRequest:
      type: object
      required:
        - customerName
        - primaryPhone
        - email
        - originAddressLine1
        - originCity
        - originState
        - originPostalCode
        - destinationAddressLine1
        - destinationCity
        - destinationState
        - destinationPostalCode
        - moveDate
        - leadSource
      properties:
        customerName:
          type: string
          minLength: 1
        primaryPhone:
          type: string
          minLength: 1
        secondaryPhone:
          type: string
        email:
          type: string
          format: email
        originAddressLine1:
          type: string
          minLength: 1
        originCity:
          type: string
          minLength: 1
        originState:
          type: string
          minLength: 1
        originPostalCode:
          type: string
          minLength: 1
        destinationAddressLine1:
          type: string
          minLength: 1
        destinationCity:
          type: string
          minLength: 1
        destinationState:
          type: string
          minLength: 1
        destinationPostalCode:
          type: string
          minLength: 1
        moveDate:
          type: string
          format: date
        pickupTime:
          type: string
        leadSource:
          type: string
          minLength: 1
        moveSize:
          type: string
        locationType:
          type: string
        estimatedTotalCents:
          type: integer
          format: int64
          minimum: 0
        depositCents:
          type: integer
          format: int64
          minimum: 0
        notes:
          type: string
    UpdateEstimateRequest:
      type: object
      properties:
        customerName:
          type: string
          minLength: 1
        primaryPhone:
          type: string
          minLength: 1
        secondaryPhone:
          type: string
        email:
          type: string
          format: email
        originAddressLine1:
          type: string
          minLength: 1
        originCity:
          type: string
          minLength: 1
        originState:
          type: string
          minLength: 1
        originPostalCode:
          type: string
          minLength: 1
        destinationAddressLine1:
          type: string
          minLength: 1
        destinationCity:
          type: string
          minLength: 1
        destinationState:
          type: string
          minLength: 1
        destinationPostalCode:
          type: string
          minLength: 1
        moveDate:
          type: string
          format: date
        pickupTime:
          type: string
        leadSource:
          type: string
          minLength: 1
        moveSize:
          type: string
        locationType:
          type: string
        estimatedTotalCents:
          type: integer
          format: int64
          minimum: 0
        depositCents:
          type: integer
          format: int64
          minimum: 0
        notes:
          type: string
    Estimate:
      type: object
      required:
        - id
        - tenantId
        - estimateNumber
        - customerId
        - customerName
        - primaryPhone
        - email
        - status
        - originAddressLine1
        - originCity
        - originState
        - originPostalCode
        - destinationAddressLine1
        - destinationCity
        - destinationState
        - destinationPostalCode
        - moveDate
        - leadSource
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        estimateNumber:
          type: string
        customerId:
          type: string
          format: uuid
        customerName:
          type: string
        primaryPhone:
          type: string
        secondaryPhone:
          type: string
        email:
          type: string
          format: email
        status:
          type: string
          enum: [draft, converted]
        originAddressLine1:
          type: string
        originCity:
          type: string
        originState:
          type: string
        originPostalCode:
          type: string
        destinationAddressLine1:
          type: string
        destinationCity:
          type: string
        destinationState:
          type: string
        destinationPostalCode:
          type: string
        moveDate:
          type: string
          format: date
        pickupTime:
          type: string
        leadSource:
          type: string
        moveSize:
          type: string
        locationType:
          type: string
        estimatedTotalCents:
          type: integer
          format: int64
        depositCents:
          type: integer
          format: int64
        notes:
          type: string
        convertedJobId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    EstimateResponse:
      type: object
      required: [estimate, requestId]
      properties:
        estimate:
          $ref: '#/components/schemas/Estimate'
        requestId:
          type: string
    UpdateJobRequest:
      type: object
      properties:
        scheduledDate:
          type: string
          format: date
        pickupTime:
          type: string
        status:
          type: string
          enum: [booked, scheduled, completed, cancelled]
    CalendarJobCard:
      type: object
      required:
        - jobId
        - jobNumber
        - scheduledDate
        - customerName
        - originShort
        - destinationShort
        - status
        - hasStorage
        - balanceDueCents
      properties:
        jobId:
          type: string
          format: uuid
        jobNumber:
          type: string
        scheduledDate:
          type: string
          format: date
        pickupTime:
          type: string
        customerName:
          type: string
        originShort:
          type: string
        destinationShort:
          type: string
        status:
          type: string
          enum: [booked, scheduled, completed, cancelled]
        hasStorage:
          type: boolean
        balanceDueCents:
          type: integer
          format: int64
          minimum: 0
    CalendarResponse:
      type: object
      required: [jobs, requestId]
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/CalendarJobCard'
        requestId:
          type: string
    Job:
      type: object
      required:
        - id
        - tenantId
        - jobNumber
        - customerId
        - customerName
        - primaryPhone
        - email
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        jobNumber:
          type: string
        customerId:
          type: string
          format: uuid
        customerName:
          type: string
        primaryPhone:
          type: string
        email:
          type: string
          format: email
        estimateId:
          type: string
          format: uuid
        status:
          type: string
          enum: [booked, scheduled, completed, cancelled]
        scheduledDate:
          type: string
          format: date
        pickupTime:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    JobResponse:
      type: object
      required: [job, requestId]
      properties:
        job:
          $ref: '#/components/schemas/Job'
        requestId:
          type: string
    StorageStatus:
      type: string
      enum: [in_storage, sit, out]
    CreateStorageRecordRequest:
      type: object
      required: [facility]
      properties:
        facility:
          type: string
          minLength: 1
        status:
          $ref: '#/components/schemas/StorageStatus'
        dateIn:
          type: string
          format: date
        dateOut:
          type: string
          format: date
        nextBillDate:
          type: string
          format: date
        lotNumber:
          type: string
        locationLabel:
          type: string
        vaults:
          type: integer
          minimum: 0
        pads:
          type: integer
          minimum: 0
        items:
          type: integer
          minimum: 0
        oversizeItems:
          type: integer
          minimum: 0
        volume:
          type: integer
          minimum: 0
        monthlyRateCents:
          type: integer
          format: int64
          minimum: 0
        storageBalanceCents:
          type: integer
          format: int64
          minimum: 0
        moveBalanceCents:
          type: integer
          format: int64
          minimum: 0
        lastPaymentAt:
          type: string
          format: date-time
        notes:
          type: string
    UpdateStorageRecordRequest:
      type: object
      required:
        - facility
        - status
        - vaults
        - pads
        - items
        - oversizeItems
        - volume
        - storageBalanceCents
        - moveBalanceCents
      properties:
        facility:
          type: string
          minLength: 1
        status:
          $ref: '#/components/schemas/StorageStatus'
        dateIn:
          type: string
          format: date
        dateOut:
          type: string
          format: date
        nextBillDate:
          type: string
          format: date
        lotNumber:
          type: string
        locationLabel:
          type: string
        vaults:
          type: integer
          minimum: 0
        pads:
          type: integer
          minimum: 0
        items:
          type: integer
          minimum: 0
        oversizeItems:
          type: integer
          minimum: 0
        volume:
          type: integer
          minimum: 0
        monthlyRateCents:
          type: integer
          format: int64
          minimum: 0
        storageBalanceCents:
          type: integer
          format: int64
          minimum: 0
        moveBalanceCents:
          type: integer
          format: int64
          minimum: 0
        lastPaymentAt:
          type: string
          format: date-time
        notes:
          type: string
    StorageListItem:
      type: object
      required:
        - jobId
        - jobNumber
        - customerName
        - fromShort
        - toShort
        - vaults
        - pads
        - items
        - oversizeItems
        - volume
        - storageBalanceCents
        - moveBalanceCents
        - facility
      properties:
        storageRecordId:
          type: string
          format: uuid
          nullable: true
        jobId:
          type: string
          format: uuid
        jobNumber:
          type: string
        customerName:
          type: string
        moveType:
          type: string
          nullable: true
        fromShort:
          type: string
        toShort:
          type: string
        status:
          type: string
          enum: [in_storage, sit, out]
          nullable: true
        dateIn:
          type: string
          format: date
          nullable: true
        dateOut:
          type: string
          format: date
          nullable: true
        nextBillDate:
          type: string
          format: date
          nullable: true
        lotNumber:
          type: string
          nullable: true
        locationLabel:
          type: string
          nullable: true
        vaults:
          type: integer
          minimum: 0
        pads:
          type: integer
          minimum: 0
        items:
          type: integer
          minimum: 0
        oversizeItems:
          type: integer
          minimum: 0
        volume:
          type: integer
          minimum: 0
        monthlyRateCents:
          type: integer
          format: int64
          minimum: 0
          nullable: true
        storageBalanceCents:
          type: integer
          format: int64
          minimum: 0
        moveBalanceCents:
          type: integer
          format: int64
          minimum: 0
        facility:
          type: string
    StorageListResponse:
      type: object
      required: [items, requestId]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/StorageListItem'
        nextCursor:
          type: string
          nullable: true
        requestId:
          type: string
    StorageRecord:
      type: object
      required:
        - id
        - jobId
        - jobNumber
        - customerName
        - fromShort
        - toShort
        - facility
        - status
        - vaults
        - pads
        - items
        - oversizeItems
        - volume
        - storageBalanceCents
        - moveBalanceCents
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        jobId:
          type: string
          format: uuid
        jobNumber:
          type: string
        customerName:
          type: string
        moveType:
          type: string
        fromShort:
          type: string
        toShort:
          type: string
        facility:
          type: string
        status:
          $ref: '#/components/schemas/StorageStatus'
        dateIn:
          type: string
          format: date
        dateOut:
          type: string
          format: date
        nextBillDate:
          type: string
          format: date
        lotNumber:
          type: string
        locationLabel:
          type: string
        vaults:
          type: integer
          minimum: 0
        pads:
          type: integer
          minimum: 0
        items:
          type: integer
          minimum: 0
        oversizeItems:
          type: integer
          minimum: 0
        volume:
          type: integer
          minimum: 0
        monthlyRateCents:
          type: integer
          format: int64
          minimum: 0
        storageBalanceCents:
          type: integer
          format: int64
          minimum: 0
        moveBalanceCents:
          type: integer
          format: int64
          minimum: 0
        lastPaymentAt:
          type: string
          format: date-time
        notes:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    StorageRecordResponse:
      type: object
      required: [storage, requestId]
      properties:
        storage:
          $ref: '#/components/schemas/StorageRecord'
        requestId:
          type: string
    ErrorEnvelope:
      type: object
      required: [error, requestId]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
            details:
              nullable: true
        requestId:
          type: string
